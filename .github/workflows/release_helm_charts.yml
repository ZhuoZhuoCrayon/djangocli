name: Release Helm Charts
# å¦‚æœä¸è€ƒè™‘å¼‚åº“æäº¤ release ä»¥åŠ ç»´æŠ¤ç»Ÿä¸€çš„ Helm Chartsï¼Œä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨ chart-releaser: https://github.com/helm/chart-releaser
# Helm å®˜æ–¹ä¹Ÿæä¾›äº† cr çš„ actions: https://github.com/helm/chart-releaser-action
on:
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      # æ„å»ºç¯å¢ƒçš„Pythonç‰ˆæœ¬
      PYTHON_VERSION: "3.7"
      # github æäº¤ç”¨æˆ·å
      GITHUB_USERNAME: "github-actions"
      # Chartç›®å½•
      CHART_PATH: ".helm"
      # helms charts ä»“åº“åç§°
      CHARTS_REPO_NAME: "helm-charts"
      # helms charts ä»“åº“å½’å±äºº
      CHARTS_REPO_OWNER: "ZhuoZhuoCrayon"
      # helms charts ä»“åº“åœ°å€
      CHARTS_REPO_URL: "https://zhuozhuocrayon.github.io/helm-charts"

    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v2

      - id: set-up-python
        name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - id: install-requirements
        name: Install requirements
        run: |
          pip install PyYAML
          pip install packaging
          pip install ruamel.yaml

      - name: Install Helm
        uses: azure/setup-helm@v1
        with:
          version: v3.4.0

      - id: set-env
        name: Set env
        run: |

          # æµ‹è¯• Helm æ˜¯å¦å¯åŠ¨
          helm version

          chart_yaml_path=${{ env.CHART_PATH }}/Chart.yaml
          chart_name=$( python scripts/workflows/release/op_yaml.py -f $chart_yaml_path --keyword-path name --op get )
          chart_version=$( python scripts/workflows/release/op_yaml.py -f $chart_yaml_path --keyword-path version --op get )

          # é»˜è®¤æäº¤è€…é‚®ç®±
          echo "GITHUB_EMAIL=${{ env.GITHUB_USERNAME }}@users.noreply.github.com" >> $GITHUB_ENV

          # é€šè¿‡äº‹ä»¶è·å–releaseç›¸å…³ä¿¡æ¯
          # å‚è€ƒï¼šhttps://stackoverflow.com/questions/65521101/
          # å‚è€ƒï¼šhttps://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads#release
          # release è®¿é—®åœ°å€
          echo "RELEASE_HTML_URL=${{ github.event.release.html_url }}" >> $GITHUB_ENV
          # release ä¸Šä¼ åœ°å€
          echo "RELEASE_UPLOAD_URL=${{ github.event.release.upload_url }}" >> $GITHUB_ENV

          # Chart.yaml è·¯å¾„
          echo "CHART_YAML_PATH=$chart_yaml_path" >> $GITHUB_ENV
          # Chart åç§°
          echo "CHART_NAME=$chart_name" >> $GITHUB_ENV
          # Chart ç‰ˆæœ¬å·
          echo "CHART_VERSION=$chart_version" >> $GITHUB_ENV
          # é»˜è®¤çš„ Helm Chart åŒ…å
          echo "DEFAULT_HELM_PKG_NAME=${chart_name}-${chart_version}.tgz" >> $GITHUB_ENV
          # Helm Chart åŒ…å
          echo "HELM_PKG_NAME=${chart_name}-helm-${chart_version}.tgz" >> $GITHUB_ENV
          # ä¸´æ—¶æ‰“åŒ…ç›®å½•
          echo "TMP_CHARTS_DIR=/tmp/$chart_name/charts" >> $GITHUB_ENV

      - name: Configure Git
        run: |
          git config user.name "${{ env.GITHUB_USERNAME }}"
          git config user.email "${{ env.GITHUB_EMAIL }}"

      - id: helm-package
        name: Helm package
        run: |
          # åˆå§‹åŒ–ä¸´æ—¶æ‰“åŒ…ç›®å½•
          rm -rf ${{ env.TMP_CHARTS_DIR }} & mkdir -p ${{ env.TMP_CHARTS_DIR }}
          # Chart æ‰“åŒ…
          helm package ${{ env.CHART_PATH }} -u -d ${{ env.TMP_CHARTS_DIR }}

          # Chart é‡å‘½å
          mv ${{ env.TMP_CHARTS_DIR }}/${{ env.DEFAULT_HELM_PKG_NAME }} ${{ env.TMP_CHARTS_DIR }}/${{ env.HELM_PKG_NAME }}

      - id: upload-helm-chart-package
        name: Upload Helm Chart package
        # å‚è€ƒï¼šhttps://github.com/actions/upload-release-asset
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        with:
          upload_url: ${{ env.RELEASE_UPLOAD_URL }}
          asset_path: ${{ env.TMP_CHARTS_DIR }}/${{ env.HELM_PKG_NAME }}
          asset_name: ${{ env.HELM_PKG_NAME }}
          asset_content_type: application/octet-stream

      - id: update-helm-charts-repo
        name: Update Helm charts repo
        run: |
          git clone https://github.com/${{ env.CHARTS_REPO_OWNER }}/${{ env.CHARTS_REPO_NAME }}.git

          # å…¼å®¹åˆå§‹åŒ–åˆ›å»ºæ–‡ä»¶
          mkdir -p ${{ env.CHARTS_REPO_NAME }}/${{ env.CHART_NAME }}/src

          # è¦†ç›–æ›´æ–°helmæºç 
          cp -rf .helm/* ${{ env.CHARTS_REPO_NAME }}/${{ env.CHART_NAME }}/src/

          # è·å– ChartåŒ… ä¸‹è½½ç›®å½•
          chart_download_url=${{ steps.upload-helm-chart-package.outputs.browser_download_url }}
          echo "â¬‡ï¸ chart_download_url -> $chart_download_url"
          chart_download_root=$( echo "$chart_download_url" | sed "s|${{ env.HELM_PKG_NAME }}||" )
          echo "ğŸ“’ chart_download_root -> $chart_download_root"

          # éå†å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œå‚è€ƒï¼šhttps://stackoverflow.com/questions/8880603/loop-through-an-array-of-strings-in-bash
          declare -a index_yaml_roots=("${{ env.CHARTS_REPO_NAME }}" "${{ env.CHARTS_REPO_NAME }}/${{ env.CHART_NAME }}")
          # æ›´æ–° index.yaml
          for index_yaml_root in "${index_yaml_roots[@]}"
          do
            # åˆå§‹åŒ– index.yaml
            if [ ! -f $index_yaml_root/index.yaml ]; then
              # å…¼å®¹ index.yaml å­˜åœ¨ charts åŒ…çš„æƒ…å†µï¼Œè¡¥å……å­è·¯å¾„ child_dir
              child_path=$( echo "$index_yaml_root" | sed "s|${{ env.CHARTS_REPO_NAME }}/||" )
              helm repo index $index_yaml_root --url ${{ env.CHARTS_REPO_URL }}/$child_path
            fi

            # åŸºäºå‡ºåŒ…è·¯å¾„ç”Ÿæˆ index.yaml å¹¶å’Œ åŸindex.yaml åˆå¹¶
            helm repo index ${{ env.TMP_CHARTS_DIR }} --url $chart_download_root --merge $index_yaml_root/index.yaml
            # æ›´æ–° åŸindex.yaml
            mv -f ${{ env.TMP_CHARTS_DIR }}/index.yaml $index_yaml_root/index.yaml
          done

      - id: update-charts-repo-index-yaml
        name: Update charts repo index yaml
        # refer: https://github.com/marketplace/actions/push-a-file-to-another-repository
        uses: dmnemec/copy_file_to_another_repo_action@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.PAT }}
        with:
          source_file: ${{ env.CHARTS_REPO_NAME }}/index.yaml
          destination_repo: ${{ env.CHARTS_REPO_OWNER }}/${{ env.CHARTS_REPO_NAME }}
          user_email: ${{ env.GITHUB_EMAIL }}
          user_name: ${{ env.GITHUB_USERNAME }}
          destination_branch: main
          commit_message: "minor: update index.yaml triggered by ${{ env.RELEASE_HTML_URL }}"

      - id: update-chart-src
        name: Update Chart src
        # refer: https://github.com/marketplace/actions/push-directory-to-another-repository
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.PAT }}
        with:
          source-directory: ${{ env.CHARTS_REPO_NAME }}/${{ env.CHART_NAME }}
          target-directory: ${{ env.CHART_NAME }}
          destination-github-username: ${{ env.CHARTS_REPO_OWNER }}
          destination-repository-name: ${{ env.CHARTS_REPO_NAME }}
          user-email: ${{ env.GITHUB_EMAIL }}
          user-name: ${{ env.GITHUB_USERNAME }}
          target-branch: main
          commit-message: "minor: update chart src triggered by ${{ env.RELEASE_HTML_URL }}"

      - id: celebrate
        name: Celebrate
        run: |
          echo "ğŸ‰ Worth celebrating"
          echo "ğŸ» All steps are successfully completed"
          echo "ğŸ‘‹ Goodbye!"
